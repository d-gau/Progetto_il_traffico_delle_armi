---
title: "0. Project"
author: "Dave"
date: "2025-12-30"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# IL TRAFFICO DI ARMI INTERAZIONALE DAL 1950 AL 2024

```{r}
# 0. Importiamo le librerie
library(tidyverse)
library(igraph)
library(tidygraph)
library(ggraph)

# Impostiamo il seed per i grafi
set.seed(123)
```

## 1. PULIZIA DATI

```{r}
# 1. Importiamo il primo dataset
# Carichiamo il dataset saltando le prime 11 righe di intestazione inutile
raw_data <- read_csv("Support files/0. trade-register.csv", skip = 11, show_col_types = FALSE)

# Pulizia Nomi Colonne e Tipi di Dato
arms_data <- raw_data %>%
  select(Recipient, Supplier, 
    Year_Order = `Year of order`, 
    Year_Delivery = `Year(s) of delivery`, 
    TIV = `SIPRI TIV of delivered weapons`, # rappresenta il valore strategico-militare di ogni arma
    Comments) %>%
  # Pulizia TIV (ha valori NA e negativi)
  mutate(TIV = as.numeric(TIV)) %>%
  filter(!is.na(TIV), TIV > 0) %>%
  # Pulizia Anni (ci sono intervalli di anni tipo "2010; 2011" -> prendiamo il primo anno per semplicità)
  mutate(Year_Start = as.integer(str_extract(Year_Delivery, regex("^\\d{4}")))) %>%
  # La Russia e la Soviet Union sono la stessa cosa -> uniamole
  mutate(Supplier = ifelse(Supplier == "Soviet Union", "Russia", Supplier),
         Recipient = ifelse(Recipient == "Soviet Union", "Russia", Recipient))
```

## 2. COSTRUZIONE GRAFO GLOBALE

```{r}
# Aggreghiamo i flussi totali tra paesi 
edges_global <- arms_data %>%
  group_by(Supplier, Recipient) %>%
  summarise(weight = sum(TIV), .groups = 'drop') %>% # invece di mettere ungroup() alla fine, lo inserisco qui altrimenti esce un warning
  filter(weight > 10) 
```

```{r}
g_global <- as_tbl_graph(edges_global, directed = TRUE) %>%
  activate(nodes) %>%
  # Community detection automatica con "group_walktrap()"
  mutate(community = as.factor(group_walktrap())) %>% 
  mutate(degree = centrality_degree(mode = "out"))
```

```{r}
# Mostriamo solo chi ha scambi significativi
g_plot <- g_global %>%
  filter(degree > 10) %>%
  group_by(community) %>%
  # Creiamo la label: se il rango del degree è <= 4, metti il nome, altrimenti vuoto ""
  mutate(label_top8 = ifelse(rank(-degree) <= 4, name, "")) %>%
  ungroup()

ggraph(g_plot, layout = "fr") +
  geom_node_point(aes(size = degree, color = community), show.legend = FALSE) +
  scale_color_manual(values = c("red","blue")) +
  geom_edge_link(aes(alpha = weight), 
                 color = "grey", show.legend = FALSE) +
  geom_node_text(aes(label = label_top8), repel = TRUE) +
  labs(title = "Le 'Fazioni' del Commercio di Armi 1950 - 2023")
```

Queste fazioni sono rappresentative più del primo dopoguerra e della guerra fredda rispetto a quella attuale.
L'Ukraina ha avuto l'indipendenza dalla Russia nel 1990, mentre la Polonia fino alla caduta del muro di Berlino faceva parte dei firmatari del patto di Varsavia

## Analisi 1950 - 1997 (Trattato di Parigi) 

```{r}
# Aggreghiamo i flussi totali tra paesi 
edges_global <- arms_data %>%
  filter(Year_Order <= 1997) %>%
  group_by(Supplier, Recipient) %>%
  summarise(weight = sum(TIV), .groups = 'drop') %>% # invece di mettere ungroup() alla fine, lo inserisco qui altrimenti esce un warning
  filter(weight > 10) 
edges_global
```

```{r}
g_global <- as_tbl_graph(edges_global, directed = TRUE) %>%
  activate(nodes) %>%
  # Community detection automatica con "group_walktrap()"
  mutate(community = as.factor(group_walktrap())) %>% 
  mutate(degree = centrality_degree(mode = "out"))
g_global
```

```{r}
# Mostriamo solo chi ha scambi significativi
g_plot <- g_global %>%
  filter(degree > 10) %>%
  group_by(community) %>%
  # Creiamo la label: se il rango del degree è <= 4, metti il nome, altrimenti vuoto ""
  mutate(label_top8 = ifelse(rank(-degree) <= 4, name, "")) %>%
  ungroup()

ggraph(g_plot, layout = "fr") +
  geom_node_point(aes(size = degree, color = community), show.legend = FALSE) +
  scale_color_manual(values = c("blue", "red")) +
  geom_edge_link(aes(alpha = weight), 
                 color = "grey", show.legend = FALSE) +
  geom_node_text(aes(label = label_top8), repel = TRUE) +
  labs(title = "Le 'Fazioni' del Commercio di Armi 1950 - 1997")
```
## Analisi 1998 - 2023  

```{r}
# Aggreghiamo i flussi totali tra paesi 
edges_global <- arms_data %>%
  filter(Year_Order > 1997) %>%
  group_by(Supplier, Recipient) %>%
  summarise(weight = sum(TIV), .groups = 'drop') %>% # invece di mettere ungroup() alla fine, lo inserisco qui altrimenti esce un warning
  filter(weight > 10) 
edges_global
```

```{r}
g_global <- as_tbl_graph(edges_global, directed = TRUE) %>%
  activate(nodes) %>%
  # Community detection automatica con "group_walktrap()"
  mutate(community = as.factor(group_walktrap())) %>% 
  mutate(degree = centrality_degree(mode = "out"))
g_global
```

```{r}
# Mostriamo solo chi ha scambi significativi
g_plot <- g_global %>%
  filter(degree > 10) %>%
  group_by(community) %>%
  # Creiamo la label: se il rango del degree è <= 4, metti il nome, altrimenti vuoto ""
  mutate(label_top8 = ifelse(rank(-degree) <= 4, name, "")) %>%
  ungroup()

ggraph(g_plot, layout = "fr") +
  geom_node_point(aes(size = degree, color = community), show.legend = FALSE) +
  scale_color_manual(values = c("blue", "red")) +
  geom_edge_link(aes(alpha = weight), 
                 color = "grey", show.legend = FALSE) +
  geom_node_text(aes(label = label_top8), repel = TRUE) +
  labs(title = "Le 'Fazioni' del Commercio di Armi 1998 - 2023")
```

## 3. CHI SONO GLI STATI CON PIÙ POTERE?

```{r}
# Un nodo ha potere se vende a chi non ha alternative (connesso a nodi "deboli") - usiamo una funzione simile a quella usata nelle lezioni
power = function(A, t) {
  n = dim(A)[1]
  
  x0 = rep(0, n)
  x1 = rep(1, n)
  x2 = rep(1, n)
  
  diff = 1
  eps = 1/10^t
  
  while (diff > eps) {
    x0 = x1
    x1 = x2
    
    # PROTEZIONE 1 (il coodice non andava): Gestione divisione per zero -> Aggiungiamo epsilon.
    x_inverse = 1 / (x2 + 1e-10)
    
    # PROTEZIONE 2: Gestione NaN/Inf dopo l'inversione -> lo mettiamo a 0
    x_inverse[is.infinite(x_inverse) | is.na(x_inverse)] = 0
    
    # Calcolo matriciale
    x2 = x_inverse %*% A
    
    # Normalizzazione interna per evitare numeri giganti durante il loop
    if(max(abs(x2)) > 0) {
      x2 = x2 / max(abs(x2))
    }
    
    # Calcolo diff (con gestione NA nel caso remoto ne siano rimasti)
    diff = sum(abs(x2 - x0), na.rm = TRUE)
  }
  
  # Calcolo finale Alpha 
  val_ref = x2[1]
  if(is.na(val_ref) || val_ref == 0) val_ref = 1e-10
  
  # Qui usiamo drop() per assicurarci che sia un numero scalare e non una matrice 1x1
  term1 = drop((1 / (x2 + 1e-10)) %*% A[,1])
  alpha = term1 / val_ref
  
  # Se alpha è negativo o NA (può capitare con dati sporchi), usiamo valore assoluto
  x2 = sqrt(abs(alpha)) * x2
  
  # Restituiamo il vettore con i poteri
  return(as.vector(x2))
}
```

```{r}
# 1. Creiamo la matrice di adiacenza per poi usarla con input alla funzione power
A_sipri <- as_adjacency_matrix(g_global, attr = "weight", sparse = FALSE)

# 2. Lancia la funzione "Power" con la matrice trasposta (questo perchè in A_sipri -> le righe sono i Fornitori e le colonne i Clienti)
risultato_power <- power(t(A_sipri), t = 15) 

# 3. Assegna il power al grafo
V(g_global)$power <- risultato_power
```

```{r}
classifica_potere <- data_frame(
  Stato = V(g_global)$name,
  Volume_Export = V(g_global)$degree,   # Questo è quanto vendono
  Potere_Strategico = V(g_global)$power # Questo è il calcolo della funzione
) %>%
  arrange(desc(Potere_Strategico)) # Ordina dal più potente

# Mostra le prime 10 righe
print(top_n(classifica_potere, 10,wt = "Potere_Strategico"))
```
 
```{r}
# 1. Identifichiamo i 7 Paesi con il Power più alto
top_power_countries <- tibble(
  name = V(g_global)$name, 
  power = V(g_global)$power
) %>%
  arrange(desc(power)) %>%
  slice(1:7) %>%
  pull(name)

# 2. Ciclo per generare e stampare un grafico per ciascuno

for (country in top_power_countries) {
  
  # A. Filtriamo solo gli archi che partono dal Paese interessato
  self_edges <- edges_global %>%
    filter(Supplier == country) %>%
    # Teniamo solo i clienti rilevanti 
    filter(weight > quantile(weight, 0.85)) 
  
  # B. Creiamo il grafo per ogni Paese 
  g_self <- as_tbl_graph(self_edges, directed = TRUE) %>%
    activate(nodes) %>%
    mutate(type = ifelse(name == country, "Supplier", "Customer"),
           volume_in = centrality_degree(weights = weight, mode = "in"),
           size_plot = ifelse(type == "Supplier", 15, (volume_in / max(volume_in)) * 10))
  
  # C. Disegno con ggraph
  # Layout 'star' o 'fr' funzionano bene per mostrare un centro e i raggi
  p <- ggraph(g_self, layout = "fr") + 
    
    # Archi che partono dal centro
    geom_edge_fan(aes(width = weight), alpha = 0.6, color = "grey", show.legend = FALSE) +
    
    # Nodi: Il fornitore in Rosso, i clienti in Blu
    geom_node_point(aes(color = type, size = size_plot), show.legend = FALSE) +
    scale_color_manual(values = c("Supplier" = "red", "Customer" = "blue")) +
    
    # Mettiamo i nomi ai vari nodi
    geom_node_text(aes(label = name), repel = TRUE, size = 4, fontface = "bold", show.legend = FALSE) +
    
    # Titoli
    labs(title = paste("Paese:", country)) +
    theme_graph() 
  
  # Stampa il grafico
  print(p)
}
```

## 4. COM'È ANDATO NEL TEMPO IL TRAFFICO DI ARMI?

```{r}
# 1. Preparazione Dati
trend_temporale <- arms_data %>%
  group_by(Year_Start) %>%
  summarise(Total_Volume = sum(TIV))

# 2. Visualizzazione
ggplot(trend_temporale, aes(x = Year_Start, y = Total_Volume)) +
  
  # Linea precisa anno per anno
  geom_line(color = "darkblue", size = 1) +
  
  # Etichette e Titoli
  labs(
    title = "Corsa agli Armamenti: Analisi Storica (1950-2023)",
    x = "Anno",
    y = "Volume Totale Armi (Trend Indicator Value)"
  ) +
  theme_minimal()
```

Possiamo individuare 3 picchi:
- Anni '80: Il picco più alto (tensioni della Guerra Fredda, guerra Iran-Iraq);
- Anni 2000: L'aumento di armi in seguito all'attentato dell'11 settembre;
- 2014: Guerra di Crimea.

## 5. CON LE ARMI DI CHI STANNO COMBATTENDO I CONFLITTI DI OGGI?

### Israele

```{r}
# 1. Carichiamo i dati
israel_data_raw <- read_csv("Support files/0. Israel trade-register 2010- 2024.csv", skip = 11, show_col_types = FALSE)
israel_data_raw
```

```{r}
# 2. Pulizia Nomi e Conversione Numeri
israel_arms <- israel_data_raw %>%
  select(
    Supplier, 
    Weapon_Type = `Weapon description`,    # Cosa è? (Carro armato, Missile...)
    Weapon_Name = `Weapon designation`,    # Nome modello (F-35, Merkava...)
    Delivery_Year = `Year(s) of delivery`,
    Quantity = `Number delivered`,         # Quanti pezzi?
    TIV = `SIPRI TIV of delivered weapons;;;;;;;;;;;;;;;` # Valore militare
  ) %>%
  # Puliamo la colonna TIV con caratteri strani nel CSV
  mutate(TIV = as.numeric(str_extract(as.character(TIV), "[0-9.]*"))) %>%
  filter(!is.na(TIV)) %>%
  # Puliamo la colonna Quantità 
  mutate(Quantity = as.numeric(str_remove_all(as.character(Quantity), "[^0-9.]")))

israel_arms
```

### ANALISI 1: I FORNITORI - Chi sostiene lo sforzo bellico

```{r}
supplier_ranking <- israel_arms %>%
  group_by(Supplier) %>%
  summarise(
    Total_Value_TIV = sum(TIV, na.rm = TRUE),
    Total_Pieces = sum(Quantity, na.rm = TRUE)
  ) %>%
  arrange(desc(Total_Value_TIV))

supplier_ranking
```
```{r}
ggplot(supplier_ranking, aes(x = reorder(Supplier, Total_Value_TIV), y = Total_Value_TIV)) +
  geom_col(fill = "steelblue") +
  coord_flip() + 
  labs(
    title = "Chi arma Israele? (2010-2024)",
    x = "Fornitore",
    y = "Volume Armi (TIV)"
  ) +
  geom_text(aes(label = round(Total_Value_TIV, 0)), hjust = -0.1) +
  theme_minimal()
```

### ANALISI 2: L'ARSENALE - Cosa viene fornito

```{r}
# Raggruppiamo per tipo di arma per vedere la composizione
arsenal_composition <- israel_arms %>%
  group_by(Weapon_Type, Supplier) %>%
  summarise(
    Count = sum(Quantity, na.rm = TRUE),
    Value = sum(TIV, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  arrange(desc(Value))

arsenal_composition
```

```{r}
# Grafico: Composizione dell'Import
ggplot(arsenal_composition, aes(x = reorder(Weapon_Type, Value), y = Value)) +
  geom_col(aes(fill = Value), show.legend = FALSE) +
  coord_flip() +
  labs(
    title = "Composizione dell'Arsenale",
    x = "Tipo di Arma",
    y = "Valore Strategico (TIV)"
  ) +
  theme_minimal()
```

### Ukraina

```{r}
# 1. Carichiamo il file specifico (saltiamo le righe si intestazione)
ukraine_data_raw <- read_csv("Support files/0. Ukraine trade-register 2010-2024.csv", skip = 11, show_col_types = FALSE)
```

```{r}
# 2. Pulizia Nomi e Conversione Numeri
ukraine_arms <- ukraine_data_raw %>%
  select(
    Supplier, 
    Weapon_Type = `Weapon description`,    # Cosa è? (Carro armato, Missile...)
    Weapon_Name = `Weapon designation`,    # Nome modello (F-35, Merkava...)
    Delivery_Year = `Year(s) of delivery`,
    Quantity = `Number delivered`,         # Quanti pezzi?
    TIV = `SIPRI TIV of delivered weapons` # Valore militare
  ) %>%
  # Puliamo la colonna TIV 
  mutate(TIV = as.numeric(str_extract(as.character(TIV), "[0-9.]*"))) %>%
  filter(!is.na(TIV)) %>%
  # Puliamo la colonna Quantità 
  mutate(Quantity = as.numeric(str_remove_all(as.character(Quantity), "[^0-9.]")))

ukraine_arms
```

### ANALISI 1: I FORNITORI - Chi sostiene lo sforzo bellico

```{r}
supplier_ranking <- ukraine_arms %>%
  group_by(Supplier) %>%
  summarise(
    Total_Value_TIV = sum(TIV, na.rm = TRUE),
    Total_Pieces = sum(Quantity, na.rm = TRUE)
  ) %>%
  arrange(desc(Total_Value_TIV)) %>%
  filter(Total_Value_TIV > 100)

supplier_ranking
```

```{r}
ggplot(supplier_ranking, aes(x = reorder(Supplier, Total_Value_TIV), y = Total_Value_TIV)) +
  geom_col(fill = "steelblue") +
  coord_flip() + 
  labs(
    title = "Chi arma l'Ukraina? (2010-2024)",
    x = "Fornitore",
    y = "Volume Armi (TIV)"
  ) +
  geom_text(aes(label = round(Total_Value_TIV, 0)), hjust = -0.1) +
  theme_minimal()
```

### ANALISI 2: L'ARSENALE - Cosa viene fornito

```{r}
# Raggruppiamo per tipo di arma per vedere la composizione
arsenal_composition <- ukraine_arms %>%
  group_by(Weapon_Type) %>%
  summarise(
    Count = sum(Quantity, na.rm = TRUE),
    Value = sum(TIV, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  arrange(desc(Value))%>%
  filter(Value > 100)

arsenal_composition
```

```{r}
# Grafico: Composizione dell'Import
ggplot(arsenal_composition, aes(x = reorder(Weapon_Type, Value), y = Value)) +
  geom_col(aes(fill = Value), show.legend = FALSE) +
  coord_flip() +
  labs(
    title = "Composizione dell'Arsenale",
    x = "Tipo di Arma",
    y = "Valore Strategico (TIV)"
  ) +
  theme_minimal()
```